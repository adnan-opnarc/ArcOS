#include "bitmap.h"
#include "../crp/bitmap.h"
#include "shell.h"
#include "../crp/string.h"
#include <stdint.h>
#include "../root/kernel.h"

static const uint8_t cool_bitmap[] = {0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x7f,0xff,0xc7,0x9f,0xff,0xff,0xff,0xff,0xff,0xff,0x3f,0xff,0x03,0x0f,0xff,0xff,0xff,0xff,0xff,0xfe,0x38,0x23,0x38,0x6f,0xff,0xff,0xff,0xff,0xff,0xfe,0x18,0x00,0x79,0x3f,0xff,0xff,0xff,0xff,0xff,0xfe,0x99,0xc8,0x79,0x0f,0xff,0xff,0xff,0xff,0xff,0xfc,0x19,0xce,0x79,0xc7,0xff,0xff,0xff,0xff,0xff,0xfd,0xc9,0xcf,0x38,0x67,0xff,0xff,0xff,0xff,0xff,0xf9,0xc9,0xc1,0x12,0x67,0xff,0xff,0xff,0xff,0xff,0xf8,0x80,0xe1,0x87,0x0f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff};

// Improved string to number conversion
static int str_to_int(const char* str, int* value) {
    int result = 0, sign = 1, i = 0;
    while (str[i] == ' ') i++; // Skip leading spaces
    if (str[i] == '-') { sign = -1; i++; }
    
    int start = i;
    while (str[i] >= '0' && str[i] <= '9') {
        result = result * 10 + (str[i] - '0');
        i++;
    }
    if (i == start) return 0; 
    *value = result * sign;
    return i;
}

// Improved hex byte parser
static int parse_hex_byte(const char* str, uint8_t* value) {
    int i = 0;
    uint8_t result = 0;
    while (str[i] == ' ' || str[i] == ',' || str[i] == '{') i++;
    
    if (str[i] == '0' && (str[i+1] == 'x' || str[i+1] == 'X')) i += 2;
    
    int digits = 0;
    while (digits < 2) {
        char c = str[i];
        uint8_t digit;
        if (c >= '0' && c <= '9') digit = c - '0';
        else if (c >= 'a' && c <= 'f') digit = c - 'a' + 10;
        else if (c >= 'A' && c <= 'F') digit = c - 'A' + 10;
        else break;
        
        result = (result << 4) | digit;
        i++; digits++;
    }
    *value = result;
    return i;
}

// Fixed Render Logic: 1:1 Pixel to Character mapping
static void render_bitmap_at_pos(const bitmap_t* bmp, int start_x, int start_y) {
    if (!bitmap_is_valid(bmp)) return;
    
    for (uint32_t y = 0; y < bmp->height; y++) {
        // Ensure we don't print outside typical terminal bounds
        move_cursor(start_x, start_y + y);
        for (uint32_t x = 0; x < bmp->width; x++) {
            uint8_t pixel = bitmap_get_pixel_raw(bmp, x, y);
            
            if (pixel) {
                putchar(0xDB); // Full block for 'on' pixels
            } else {
                putchar(' ');  // Space for 'off' pixels
            }
        }
    }
}

void bitmap_main(const char* args) {
    if (!args || args[0] == '\0') {
        bitmap_t cool = bitmap_create(cool_bitmap, sizeof(cool_bitmap), 16, 16, BITMAP_FORMAT_MONO);
        render_bitmap_at_pos(&cool, 0, 0);
        return;
    }
    
    int x, y, w, h;
    const char* p = args;

    // Helper to advance pointer after parsing
    int consumed;
    if (!(consumed = str_to_int(p, &x))) goto usage; p += consumed;
    if (!(consumed = str_to_int(p, &y))) goto usage; p += consumed;
    if (!(consumed = str_to_int(p, &w))) goto usage; p += consumed;
    if (!(consumed = str_to_int(p, &h))) goto usage; p += consumed;

    if (w <= 0 || h <= 0 || w > 128 || h > 64) {
        printk("Error: Dimensions out of range.\n");
        return;
    }

    int expected_bytes = (w * h + 7) / 8;
    uint8_t data[512]; // Increased buffer
    int count = 0;

    while (count < expected_bytes && count < 512) {
        uint8_t val;
        consumed = parse_hex_byte(p, &val);
        if (consumed == 0) break;
        data[count++] = val;
        p += consumed;
    }

    if (count < expected_bytes) {
        return;
    }

    bitmap_t bmp = bitmap_create(data, count, w, h, BITMAP_FORMAT_MONO);
    render_bitmap_at_pos(&bmp, x, y);
    return;

usage:
    printk("Usage: bitmap <x> <y> <w> <h> <data...>\n");
}